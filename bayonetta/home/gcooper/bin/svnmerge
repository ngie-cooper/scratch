#!/bin/sh

set -eux

if [ -d "$1" ]; then
	from=$(realpath "$1")
else
	from=$1
fi
to=$(realpath "$2")

shift 2

[ $# -gt 0 ]

for i in $(echo $* | tr ' ' '\012' | sort -nu); do
	svn merge -c $i "$from" "$to"
done

set -x
SRC_URL=$(svn info "$from" | awk '$1 == "URL:" { print $NF }')
SRC_RROOT=$(svn info "$from" | awk '/^Repository Root:/ { print $NF }')
DEST_URL=$(svn info "$to" | awk '$1 == "URL:" { print $NF }')
DEST_RROOT=$(svn info "$to" | awk '/^Repository Root:/ { print $NF }')
cat > "$to/commit" <<EOF
Merge changes from $(echo $SRC_URL | sed -e "s,$SRC_RROOT/,,g") to $(echo $DEST_URL | sed -e "s,$DEST_RROOT/,,g") 
EOF
for i in $(echo $* | tr ' ' '\012' | sort -nru); do
	svn log --incremental -r$i "$from" >> "$to/commit"
done
